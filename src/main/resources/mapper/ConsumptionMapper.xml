<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="net.stepbook.domain.order.mapper.ConsumptionMapper">
    <select id="findByCriteria"
            resultType="net.stepbooks.interfaces.admin.dto.ConsumptionInfoDto">
        select o.*, b.book_name, c.chapter_name, u.username, u.nickname
        from step_consumption o
        left join step_book b
        on o.book_id = b.id
        left join step_chapter c
        on o.chapter_id = c.id
        left join step_user u
        on o.user_id = u.id
        where 1 = 1
        <if test="consumeOrderNo != null">
            and o.consume_order_no = #{consumeOrderNo}
        </if>
        <if test="username != null">
            and exists (select 1 from step_user u1 where u1.username = #{username} and o.user_id = u1.id)
        </if>
        <if test="bookName != null">
            <bind name="pattern" value="'%' + bookName + '%'"/>
            and exists (select 1 from step_book b1 where b1.book_name ILIKE #{pattern} and o.book_id = b1.id)
        </if>
    </select>
    <select id="findPageByUser"
            resultType="net.stepbooks.interfaces.admin.dto.ConsumptionInfoDto">
        select o.*, b.book_name, c.chapter_name, c.chapter_number, u.username
        from step_consumption o
        left join step_book b
        on o.book_id = b.id
        left join step_chapter c
        on o.chapter_id = c.id
        left join step_user u
        on o.user_id = u.id
        where o.user_id = #{userId}
        order by o.created_at desc
    </select>
</mapper>